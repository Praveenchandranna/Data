name: Check Code Coverage and Deploy

on:
  push:
    branches:
      - main

jobs:
  check-coverage-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Salesforce CLI
        uses: salesforcecli/sfdx-cli-action@v1
        with:
          version: 'latest'

      - name: Install jq
        run: sudo apt-get install jq

      - name: Run Apex tests and collect coverage
        id: run-tests
        run: |
          test_results=$(sfdx force:apex:test:run -c -r json -w 10 -l RunLocalTests)
          echo "::set-output name=test-results::$test_results"

      - name: Parse coverage results and calculate total coverage
        id: calculate-coverage
        run: |
          total_coverage=$(echo "${{ steps.run-tests.outputs.test-results }}" | jq '.result.coverage.coverage')
          echo "::set-output name=total-coverage::$total_coverage"

      - name: Check coverage threshold
        id: check-coverage
        run: |
          coverage_threshold=85
          if (( $(echo "${{ steps.calculate-coverage.outputs.total-coverage }} > $coverage_threshold" | bc -l) )); then
              echo "Code coverage is above 85%. Proceeding with deployment..."
              # Deploy to Salesforce org
              sfdx force:source:deploy -p path/to/source -u orgAlias
          else
              echo "Code coverage is below 85%. Deployment aborted."
              exit 1
          fi
